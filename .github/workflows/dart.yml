name: Combined Android & iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      skip-android:
        description: 'Skip Android build?'
        required: false
        default: 'false'
        type: boolean
      skip-ios:
        description: 'Skip iOS build?'
        required: false
        default: 'false'
        type: boolean

env:
  NDK_VERSION: '27.0.11718014'

jobs:
  android:
    name: Android Build
    if: ${{ !inputs.skip-android || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # JDK 17 setup
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # Node.js setup
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    # Android setup (official actions)
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
    
    # Install specific NDK version
    - name: Install Android NDK
      run: |
        echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;$NDK_VERSION"
        echo "NDK_VERSION=$NDK_VERSION" >> $GITHUB_ENV
        echo "NDK_HOME=${ANDROID_HOME}/ndk/$NDK_VERSION" >> $GITHUB_ENV
    
    # Cache node_modules
    - uses: actions/cache@v3
      id: node-cache
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    # Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        cd android && ./gradlew dependencies
    
    # Build release APK
    - name: Build APK
      run: |
        cd android && ./gradlew assembleRelease \
          -PMYAPP_RELEASE_STORE_FILE=keystore.jks \
          -PMYAPP_RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }} \
          -PMYAPP_RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
          -PMYAPP_RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
    
    # Upload APK artifact
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: app-release-android
        path: android/app/build/outputs/apk/release/app-release.apk

  ios:
    name: iOS Build
    needs: android
    if: ${{ !inputs.skip-ios || github.event_name != 'workflow_dispatch' }}
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Node.js setup
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    # Cache for node_modules and CocoaPods
    - uses: actions/cache@v3
      id: node-cache
      with:
        path: |
          ~/.npm
          node_modules
          ios/Pods
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    # Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        cd ios && pod install
    
    # Build and archive
    - name: Build iOS app
      run: |
        cd ios && xcodebuild \
          -workspace Aurore.xcworkspace \
          -scheme Aurore \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/Aurore.xcarchive \
          clean archive
    
    # Export IPA
    - name: Export IPA
      run: |
        cd ios && xcodebuild \
          -exportArchive \
          -archivePath build/Aurore.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build \
          -allowProvisioningUpdates
    
    # Upload IPA artifact
    - name: Upload IPA
      uses: actions/upload-artifact@v3
      with:
        name: app-release-ios
        path: ios/build/Aurore.ipa
