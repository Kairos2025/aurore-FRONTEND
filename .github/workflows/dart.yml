name: Build Aurore School APK

on:
  push:
    branches: [update-gradle]
  pull_request:
    branches: [update-gradle]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: 'aurore-FRONTEND'
          fetch-depth: 0

      - name: Initialize Assets
        run: |
          # Create base assets directory if missing
          mkdir -p aurore-FRONTEND/assets
          
          # Check existing files
          echo "=== PRE-STRUCTURE ==="
          ls -laR aurore-FRONTEND || true

      - name: Fix File Structure
        run: |
          cd aurore-FRONTEND
          
          # Handle all possible asset locations
          mkdir -p assets/images/aurore_icons
          
          # 1. Fix double extensions anywhere
          find . -name "*.png.png" -exec rename 's/\.png\.png$/.png/' {} \; || true
          
          # 2. Collect assets from all potential locations
          cp -n android/app/src/main/res/mipmap-*/ic_*.png assets/images/aurore_icons/ 2>/dev/null || true
          cp -n windows/runner/resources/*.png assets/images/aurore_icons/ 2>/dev/null || true
          cp -n assets/icons/*.png assets/images/aurore_icons/ 2>/dev/null || true
          cp -n assets/*.png assets/images/aurore_icons/ 2>/dev/null || true

      - name: Final Verification
        run: |
          echo "=== FINAL STRUCTURE ==="
          ls -laR aurore-FRONTEND/assets
          
          echo "=== REQUIRED FILES ==="
          declare -a required=(
            "dashboard.png" 
            "timetable.png"
            "attendance_present.png"
            "attendance_absent.png"
            "grades.png"
            "profile.png"
            "settings.png"
            "logout.png"
            "communication.png"
            "analytics.png"
            "qr_scan.png"
          )
          
          for file in "${required[@]}"; do
            if [ -f "aurore-FRONTEND/assets/images/aurore_icons/$file" ]; then
              echo "âœ“ Found: $file"
            else
              echo "::error::Missing: $file"
              exit 1
            fi
          done

      - name: Configure Project
        working-directory: aurore-FRONTEND
        run: |
          # Update pubspec.yaml
          sed -i 's/- assets\/.*/- assets\/images\/aurore_icons\//g' pubspec.yaml
          flutter pub get

      - name: Build APK
        working-directory: aurore-FRONTEND
        run: |
          flutter build apk --release --verbose

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: school-apk
          path: aurore-FRONTEND/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
