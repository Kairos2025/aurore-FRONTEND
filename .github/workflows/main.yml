name: Build APK

on:
  push:
    branches:
      - update-gradle
  pull_request:
    branches:
      - update-gradle

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository with a specific path
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: aurore-FRONTEND

      # Set up Java (required for Android builds)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Fetch the latest stable Flutter version
      - name: Fetch latest stable Flutter version
        run: |
          echo "Fetching the latest stable Flutter version..."
          git clone --depth 1 --branch stable https://github.com/flutter/flutter.git flutter_latest
          cd flutter_latest
          ./bin/flutter --version
          flutter_version=$(./bin/flutter --version --machine | grep -oP '"frameworkVersion": "\K[0-9]+\.[0-9]+\.[0-9]+')
          echo "Latest stable Flutter version: $flutter_version"
          echo "FLUTTER_VERSION=$flutter_version" >> $GITHUB_ENV
          cd ..
          rm -rf flutter_latest

      # Set up Flutter with the latest stable version
      - name: Set up Flutter
        uses: subosito/flutter-action@v2.8.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          architecture: 'x64'

      # Verify Flutter and Dart version
      - name: Verify Flutter setup
        run: |
          flutter doctor -v || { echo "Error: Flutter setup failed"; exit 1; }
          flutter --version || { echo "Error: Flutter not found"; exit 1; }
          dart --version || { echo "Error: Dart not found"; exit 1; }
          dart_version=$(dart --version 2>&1 | grep -oP '\d+\.\d+\.\d+')
          echo "Dart version: $dart_version"

      # Accept Android licenses
      - name: Accept Android licenses
        working-directory: ./aurore-FRONTEND/aurore_frontend
        run: |
          yes | flutter doctor --android-licenses || { echo "Error: Failed to accept Android licenses"; exit 1; }

      # Verify working directory and project root
      - name: Verify directory
        run: |
          pwd
          ls -la .
          if [ -d "./aurore-FRONTEND" ]; then
            echo "Found aurore-FRONTEND directory"
            cd ./aurore-FRONTEND
            ls -la .
            if [ -d "./aurore_frontend" ]; then
              echo "Found aurore_frontend directory"
              cd ./aurore_frontend
              ls -la .
              if [ -f "pubspec.yaml" ]; then
                echo "Found pubspec.yaml in aurore_frontend"
              else
                echo "Error: pubspec.yaml not found in aurore_frontend"; exit 1
              fi
            else
              echo "Error: aurore_frontend directory not found"; exit 1
            fi
          else
            echo "Error: aurore-FRONTEND directory not found"; exit 1
          fi

      # Get Flutter dependencies (initial run to ensure compatibility)
      - name: Install initial dependencies
        working-directory: ./aurore-FRONTEND/aurore_frontend
        run: |
          flutter pub get || { echo "Error: Failed to get initial dependencies"; echo "pubspec.yaml content:"; cat pubspec.yaml; exit 1; }

      # Regenerate Android project structure
      - name: Regenerate Android project
        working-directory: ./aurore-FRONTEND/aurore_frontend
        run: |
          # Backup existing android directory
          if [ -d "android" ]; then
            mv android android_backup
            echo "Backed up existing android directory to android_backup"
          fi
          # Create new project structure
          flutter create -t app . --platforms android
          # Restore pubspec.yaml
          cp pubspec.yaml pubspec.yaml.bak  # Backup new pubspec.yaml
          cp ./pubspec.yaml .  # Restore original pubspec.yaml from current directory
          # Restore lib directory (Dart code)
          if [ -d "../lib" ]; then
            rm -rf lib
            cp -r ../lib .
            echo "Restored lib directory"
          else
            echo "Error: lib directory not found in parent"; exit 1
          fi
          # Restore assets
          if [ -d "../assets" ]; then
            rm -rf assets
            cp -r ../assets .
            echo "Restored assets directory"
          else
            echo "Warning: assets directory not found in parent, using default"
          fi
          # Restore fonts (if any)
          if [ -d "../fonts" ]; then
            rm -rf fonts
            cp -r ../fonts .
            echo "Restored fonts directory"
          else
            echo "Warning: fonts directory not found in parent, using default"
          fi

      # Get Flutter dependencies (after migration)
      - name: Install dependencies
        working-directory: ./aurore-FRONTEND/aurore_frontend
        run: |
          flutter pub get || { echo "Error: Failed to get dependencies"; echo "pubspec.yaml content:"; cat pubspec.yaml; exit 1; }

      # Set up Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          sdk-level: '33'
          ndk-version: '25.1.8937393'

      # Build the APK
      - name: Build APK
        working-directory: ./aurore-FRONTEND/aurore_frontend
        run: |
          flutter build apk --release || { echo "Error: APK build failed"; cat android/build.gradle; exit 1; }

      # Upload the APK as an artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: aurore-FRONTEND/aurore-FRONTEND/aurore_frontend/build/app/outputs/flutter-apk/app-release.apk
