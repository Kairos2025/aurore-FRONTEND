name: Build Aurore School APK

on:
  push:
    branches: [update-gradle]
  pull_request:
    branches: [update-gradle]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: 'src'  # Explicit checkout directory

      - name: Find Flutter project
        id: find-project
        run: |
          cd src
          if [ -f "pubspec.yaml" ]; then
            echo "PROJECT_DIR=src" >> $GITHUB_OUTPUT
          else
            PROJECT_DIR=$(find . -name pubspec.yaml -printf '%h\n' | head -1)
            echo "PROJECT_DIR=src/${PROJECT_DIR#./}" >> $GITHUB_OUTPUT
          fi
          echo "Project directory: ${{ steps.find-project.outputs.PROJECT_DIR }}"

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Set up Flutter
        uses: flutter-actions/setup-flutter@v2
        with:
          flutter-version: '3.22.1'
          channel: 'stable'
          cache: true

      - name: Update dependencies
        working-directory: ${{ steps.find-project.outputs.PROJECT_DIR }}
        run: |
          # Update google_sign_in to compatible version
          sed -i 's/google_sign_in: ^6.3.0/google_sign_in: ^6.1.1/' pubspec.yaml
          # Update SDK constraint
          sed -i "s/sdk: '>=3.4.0 <4.0.0'/sdk: '>=3.4.0 <4.0.0'/" pubspec.yaml
          cat pubspec.yaml | grep -E 'google_sign_in:|sdk:'

      - name: Install dependencies
        working-directory: ${{ steps.find-project.outputs.PROJECT_DIR }}
        run: |
          flutter pub get

      - name: Build APK
        working-directory: ${{ steps.find-project.outputs.PROJECT_DIR }}
        run: |
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: aurore-school-apk
          path: ${{ steps.find-project.outputs.PROJECT_DIR }}/build/app/outputs/flutter-apk/app-release.apk
